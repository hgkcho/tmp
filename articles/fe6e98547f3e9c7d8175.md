---
title: "TCPãƒ»UDPã‚µãƒ¼ãƒã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸˆ"
type: "tech"
topics: ["TCP", "UDP"]
published: false
---

## å‰æ

è‡ªåˆ†ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼åˆå¿ƒè€…ã§ã™ã€‚
TCPãƒ»UDP ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¯è¨€åŠã—ã¾ã›ã‚“ã€‚
å…·ä½“çš„ã«ã¯ã€ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã€è¼»è¼³åˆ¶å¾¡ã€ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ç­‰ã«ã¤ã„ã¦ã¯è¨€åŠã—ã¾ã›ã‚“ã€‚
TCP ã¯ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³å¿—å‘ã§ã€UDP ã¯ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ã‚¹ã¨èã„ã¦ã„ãŸã®ã§ã€è‚Œèº«ã§æ„Ÿã˜ã‚‹ãŸã‚ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

## æ¦‚è¦ã€€

ã‚†ã‚‹ãµã‚ãªæ„Ÿã˜ã§ã‚µãƒ¼ãƒã‚’ä½œã£ã¦ã©ã®ã‚ˆã†ã«é€šä¿¡ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

nc(netcat)ã‚’ä½¿ãˆã°ã‚µãƒ¼ãƒã‚‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚‚ç”¨æ„ã§ãã‚‹ã®ã§é€šä¿¡è‡ªä½“ã¯ç°¡å˜ã«ã§ãã¾ã™ãŒã€tcpã‚µãƒ¼ãƒã‚‚ä½œã£ã¦ã¿ãŸã‹ã£ãŸã®ã§ã€ã‚µãƒ¼ãƒã®æ–¹ã¯é›°å›²æ°—ã§å®Ÿéš›ã«å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚

## å†…å®¹

Go ã§ TCP ã‚µãƒ¼ãƒåŠã³ UDP ã‚µãƒ¼ãƒã‚’ã¤ãã£ã¦é€šä¿¡ã®ç¢ºèªã‚’ã—ã¾ã™

### TCPã‚µãƒ¼ãƒã®å®Ÿè£…

é©å½“ã« Go ã§ TCP ã‚µãƒ¼ãƒã‚’ä½œã‚Šã¾ã™

```go
package main

import (
	"bufio"
	"context"
	"errors"
	"fmt"
	"io"
	"log"
	"net"
	"os"
	"os/signal"
	"strings"
	"syscall"
	"time"
)

var dead = 10 * time.Second

func main() {
	if err := run(); err != nil {
		fmt.Printf("error: %v\n", err)
	}
}

func run() error {
	termCh := make(chan os.Signal, 1)
	signal.Notify(termCh, syscall.SIGKILL, syscall.SIGINT)
	errCh := make(chan error, 1)

	addr := &net.TCPAddr{
		IP:   net.ParseIP("127.0.0.1"),
		Port: 8000,
	}
	ln, err := net.ListenTCP("tcp", addr)
	if err != nil {
		return err
	}

	log.Println("Starting tcp server...")

	go func() {
		for {
			ctx := context.Background()
			conn, err := ln.Accept()
			if err != nil {
				errCh <- err
			}
			go func() {
				err = handle(ctx, conn)
				if !(errors.Is(err, os.ErrDeadlineExceeded) || errors.Is(err, io.EOF)) {
					errCh <- err
				}
				fmt.Println("connection is disconnected ")
			}()
		}
	}()

	select {
	case <-termCh:
		return errors.New("terminated by signal")
	case err = <-errCh:
		return err
	}
}

func handle(ctx context.Context, conn net.Conn) error {
	ctx, cancel := context.WithCancel(ctx)
	defer cancel()
	go func() {
		<-ctx.Done()
		conn.Close()
	}()

	err := conn.SetDeadline(time.Now().Add(dead))
	if err != nil {
		return err
	}
	defer conn.Close()

	r := bufio.NewReader(conn)
	for {
		t, err := r.ReadString('\n')
		if err != nil {
			return err
		}

		log.Printf("Receiving data: %v from %s", strings.TrimSuffix(t, "\n"), conn.RemoteAddr().String())
		log.Printf("Sending data..")
		conn.Write([]byte(fmt.Sprintf("received msg: %s\n", strings.TrimSuffix(t, "\n"))))
		log.Printf("Complete Sending data..")
	}
}
```

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’10ã«ã—ã¦é€šä¿¡ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚


nc(netcat)ã‚³ãƒãƒ³ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã¿ã¾ã™ã€‚

`nc 127.0.0.1 8000`

`hello` ã¨ `world` ã‚’é€ã£ã¦ã¿ã¾ã™ã€‚

```plain
> hello
< received msg: hello
> world
< received msg: world
```

ã—ã£ã‹ã‚Šã‚µãƒ¼ãƒã‹ã‚‰å¿œç­”ãŒãã¦ã„ã¾ã™ã€‚

ãã®ã¾ã¾ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã€WireSharkã§ã‚‚ã¿ã¦ã¿ã¾ã™ã€‚

![tcp](https://storage.googleapis.com/zenn-user-upload/yv96g7b9tjksnogrctfuwtwp8q7j)


23~25ã§3wayãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã‚’ã—ã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚ãã®å¾Œã€ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€TCP window updateã—ã¦ãã“ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šå–ã‚Šã‚’å§‹ã‚ã¦ã„ã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã®é€å—ä¿¡ã®éƒ¨åˆ†ã§ã¯ã€ `[ACK]` -> `[PSH,ACK]` ã®é †ã§é€šä¿¡ã‚’ã—ã€`[PSH,ACK]` ã§ TCP payloadã‚’é€ã£ã¦ã„ã‚‹ã®ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚ã“ã“ã‚‰ã¸ã‚“ã¯ãƒ•ãƒ¼ãƒ³ãã‚‰ã„ã§ã€‚

æœ€å¾Œã«ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’Closeã‚’ã—ã¦ã„ã‚‹ã®ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚


### ã‚·ãƒ³ãƒ—ãƒ«ãªUDPã‚µãƒ¼ãƒã®å®Ÿè£…


```go
package main

import (
	"errors"
	"fmt"
	"log"
	"net"
	"os"
	"os/signal"
	"sync"
	"syscall"
)

func main() {
	if err := run(); err != nil {
		log.Fatal(err)
	}
}

var mux sync.RWMutex
var buf = make([]byte, 5)

func run() error {
	termCh := make(chan os.Signal, 1)
	signal.Notify(termCh, syscall.SIGKILL, syscall.SIGINT)
	errCh := make(chan error, 1)

	udpAddr := &net.UDPAddr{
		IP:   net.ParseIP("127.0.0.1"),
		Port: 6000,
	}
	ln, err := net.ListenUDP("udp", udpAddr)
	if err != nil {
		return err
	}
	defer ln.Close()

	log.Println("Starting udp server...")

	go func() {
		for {
			err = handle(ln)
			if err != nil {
				errCh <- err
			}
		}
	}()

	select {
	case <-termCh:
		return errors.New("terminated by signal")
	case err = <-errCh:
		return err
	}
}

func handle(ln *net.UDPConn) error {
	mux.Lock()
	defer mux.Unlock()
	n, addr, err := ln.ReadFromUDP(buf)
	if err != nil {
		return err
	}

	log.Printf("Receiving data: %s from %s", string(buf[:n]), addr.String())
	log.Printf("Sending data..")
	ln.WriteTo([]byte(fmt.Sprintf("received msg: %v\n", string(buf))), addr)
	log.Printf("Complete Sending data..")
	return nil
}
```

ãƒãƒƒãƒ•ã‚¡ã¯ 5byte ã—ã‹è¨±ã—ã¦ã„ã¾ã›ã‚“ã€‚ãªã®ã§ãã‚Œä»¥ä¸ŠãŒé€ã‚‰ã‚Œã¦ãã¦ã‚‚åˆ‡ã‚Šæ¨ã¦å¾¡å…ã§ã™ã€‚:sheep:

ã¾ãŸã€ãƒãƒƒãƒ•ã‚¡(`buf`)ã‚’ä½¿ã„ã¾ã‚ã—ã¦ã„ã¾ã™ãŒã€ãƒ¡ãƒ¢ãƒªã‚’é€ä¸€ç¢ºä¿ã—ãŸããªã„ãã‚‰ã„ã®æ„å›³ã§ã€ç‰¹ã«å¼·ã„æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

TCP ã¨ã®å¤§ããªé•ã„ã¯ä»¥ä¸‹ã®éƒ¨åˆ†ã§ã™ã€‚

`ln.WriteTo([]byte(fmt.Sprintf("received msg: %v\n", string(buf))), addr)`

ã“ã“ã§ `n, addr, err := ln.ReadFromUDP(buf)` ã‹ã‚‰ããŸã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã®ã‚½ã‚±ãƒƒãƒˆã«å¯¾ã—ã¦æ›¸ãè¾¼ã‚“ã§ã„ã¾ã™ã€‚ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ã‚¹ãªã®ã§ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆå±¤ã§ã¯ãƒãƒ¼ãƒˆç•ªå·ã‚’ä¿æŒã—ãªã„ã®ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã‚ˆã—ãªã«ã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã­ã€‚

ãã‚Œã§ã¯ã€nc(netcat)ã‚³ãƒãƒ³ãƒ‰ã§é€šä¿¡ã‚’ã—ã¦ã¿ã¾ã™ã€‚

`nc -u 127.0.0.1 6000`

UDP ã§é€šä¿¡ã™ã‚‹ã®ã§ `-u` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦ã„ã¾ã™ã€‚

`hello world` ã¨æ‰“ã£ã¦ã¿ã¾ã™

```plain
hello world
```

```plain
received msg: hello
```

`hello`ã¨è¿”ã£ã¦ãã¾ã—ãŸã€‚ãã£ã¡ã‚Š 5byte åˆ†ã ã‘è¿”ã£ã¦ãã¾ã—ãŸã€‚

WireShark ã§é€šä¿¡ã®ç¢ºèªã‚’ã—ã¦ã¿ã¾ã™ã€‚

![ws](https://storage.googleapis.com/zenn-user-upload/z3dpyngimp79du0comh52jeajf6a)

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã‚µãƒ¼ãƒãŒå¿œç­”ã™ã‚‹ã ã‘ã§ã™ã€‚TCPã®æ¦‚å¿µã§ã‚ã‚‹`ACK` ã‚„ `FIN` ã¨ã„ã£ãŸæ¦‚å¿µãŒãªãã€éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ã€‚
![ws](https://storage.googleapis.com/zenn-user-upload/9i0u44hwq3qectkhwp6h85pb970e)

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¦‹ã¦ã¿ã‚‹ã¨ Data çš„ã«ã¯ 12byte åˆ†(`hello world`)ã—ã£ã‹ã‚Šé€ã£ã¦ã„ã¾ã™ã€‚

## çµ‚ã‚ã‚Šã«

ã‚·ãƒ³ãƒ—ãƒ«ãªTCPã‚µãƒ¼ãƒã¨UDPã‚µãƒ¼ãƒã‚’å®Ÿè£…ã—ã¦ã€WireShark ã§é€šä¿¡ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

UDPã¯ã‚·ãƒ³ãƒ—ãƒ«ãªé€šä¿¡ã§ã™ãŒã€TCPã¯ä¿¡é ¼ã®ã‚ã‚‹é€šä¿¡ã®ãŸã‚ã«è‰²ã€…ã¨è¤‡é›‘ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã¨å®Ÿæ„Ÿã§ãã¾ã—ãŸã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒªãƒ³ã‚°ãªã©ã‚’ã—ã¦è¦ªåˆ‡ãªé€šä¿¡ã‚’ã™ã‚‹å¤§åˆ‡ã•ãŒ1ãƒŸãƒªã ã‘ç†è§£ã§ãã¾ã—ãŸã€‚

## å‚è€ƒã«ã—ãŸã‚‚ã®

* <https://speakerdeck.com/fujiwara3/kamakura-dot-go-number-5>
* <http://ganmacs.hatenablog.com/entry/2017/05/14/233104>
