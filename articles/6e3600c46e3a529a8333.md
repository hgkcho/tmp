---
title: "JWTに関して学んだ"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["JWT"]
published: false
---

## 概要

JWT の概要とその中で使われている技術に関して理解したようです。
よく認証の仕組みで使われるものです。今回は中身がどの様になっているか調べました。

## JWTとは

詳しくは[RFC 7519](https://tools.ietf.org/html/rfc7519)を参照。

> JSON Web Token (JWT) is a compact, URL-safe means of representing
  claims to be transferred between two parties.  The claims in a JWT
  are encoded as a JSON object that is used as the payload of a JSON
  Web Signature (JWS) structure or as the plaintext of a JSON Web
  Encryption (JWE) structure, enabling the claims to be digitally
  signed or integrity protected with a Message Authentication Code
   (MAC) and/or encrypted.

JSON エンコードされたデータを電子署名をつかって２者間で整合性が取れた状態でやり取りする仕組みです。

作り方を簡単に表現すると、アルゴリズムと署名したい claims と secret を用意して、ガッとすればできあがるものです。

## JWT の構造

外形は、 `Header`.`Payload`.`Signature` です。
それぞれが `.` でつながっています。
それぞれの要素について見ていきます。

<https://jwt.io/>

このサイトで簡単に JWT がどうなるか確認できるのでお試しあれ。

### Header

まずは Header を用意します。
アルゴリズムをどうするかですが、利用できる暗号スイートは以下です。

* HS256
* HS384
* HS512
* RS256
* RS384
* RS512
* ES256
* ES384
* ES512
* PS256
* PS384

今回は共通鍵を使いたいので、HMacSHA256 で行います。

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

これを Base64 URL Encoding すると...
`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9`
こうなります。

### Payload

この payload のことは claims という表現をしています。
[Claims-based identity](https://en.wikipedia.org/wiki/Claims-based_identity) の claims です。

```json
{
  "loggedInAs": "admin",
  "iat": 1422779638
}
```

これも Base64 URL Encoding すると...
`eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ`

ちなみに iat は issued_at を表していて、発行日時を表していて、有効期限の始まりを意味します。
さて、あとはこれらのデータを使って署名するだけです。

### Signature

これが JWT の肝ですね。

```plain
HMAC-SHA256(
  secret,
  base64urlEncoding(header) + '.' +
  base64urlEncoding(payload)
)
```

気をつけたいこととして、 secret の key は完全なランダムな文字でキー長は 32byte 以上にしましょう。

ref : <https://crypto.stackexchange.com/questions/34864/key-size-for-hmac-sha256>

適当にキーを作ります。

`openssl rand -base64 40 | fold -w 40`

`aMsT1GV5kH5rWzaBfybJsTYpc0NSsyec5u6CBYjL`

できました。

それではガッします。

```plain
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2dnZWRJbkFzIjoiYWRtaW4iLCJpYXQiOjE0MjI3Nzk2Mzh9.JQm7WDaqsDZnnvOJerRwpf9d8FFyevGK5-HZ7jAL5p0
```

### claimとは(余談)

claim は主体が何をできるかのステートメントであり、アプリケーション側で必要なデータをすべて書くことによって認可の仕組みを与えるものです。
当たり前ですが、発行するのは provider です。

認証と認可をあわせているように見えるがそうではありません。
claim には対象ができることとできないことが書かれているわけではありません。主体が何ものであるかとうのをシステムが認識するためのものが書かれているだけです。

従来のシステムでは、ユーザーが何者であるか何者でないか、ユーザが何をしてよいか、何をしてはいけないかの違いや類似性について混乱することがよくありました。
claim ベースの identity はそこをクリアにするようです。


## 参照

* <https://jwt.io/>
* <https://tools.ietf.org/html/rfc7519>
* <https://en.wikipedia.org/wiki/JSON_Web_Token>
